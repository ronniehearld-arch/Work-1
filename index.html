<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tracker Pro v6.7.3 - Full Professional Build</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* FULL CSS BLOCK - NO SHORTCUTS */
        .act-t { 
            border-bottom: 4px solid #4f46e5 !important; 
            color: #4f46e5 !important; 
            font-weight: 900 !important;
        } 
        .hide { display: none !important; }
        
        /* PROFESSIONAL SBT GRID STYLING */
        .sbt-grid-container { 
            display: grid; 
            grid-template-columns: 2fr 1fr; 
            gap: 1px; 
            background-color: #000000; 
            border: 2px solid #000000; 
            border-radius: 12px; 
            overflow: hidden; 
            margin-bottom: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .grid-header { 
            background-color: #f3f4f6; 
            color: #111827; 
            font-size: 10px; 
            font-weight: 900; 
            text-transform: uppercase; 
            padding: 10px 5px; 
            text-align: center; 
            border-bottom: 1px solid #000000;
        }
        .grid-cell { 
            background-color: #ffffff; 
            padding: 22px 5px; 
            font-weight: 900; 
            font-size: 13px; 
            text-align: center; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            text-transform: uppercase;
            transition: background-color 0.1s;
        }
        .grid-cell:active { 
            background-color: #e5e7eb; 
        }
        .cell-eng { 
            background-color: #f9fafb; 
            color: #4f46e5; 
            border-left: 1px solid #000000; 
            font-style: italic;
        }
        .prompt-btn {
            transition: transform 0.1s;
        }
        .prompt-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans pb-24 text-gray-900 select-none">

    <div onclick="exitN()" class="bg-black text-white text-[10px] font-bold text-center py-2 uppercase cursor-pointer sticky top-0 z-[150] tracking-widest">
        Tracker Pro v6.7.3 | (Tap to Switch User)
    </div>

    <div id="app" class="hide min-h-screen">
        <div class="bg-white sticky top-8 z-50 shadow-md">
            <div class="flex justify-between p-3 bg-gray-50 border-b text-[10px] font-black uppercase tracking-tight">
                 <button onclick="exitL()" class="text-blue-600 font-bold px-2">‚¨Ö LOCATIONS</button>
                 <span id="u-lab" class="text-gray-400"></span>
            </div>
            <div class="flex border-b">
                <button onclick="tab('baseline')" id="b-baseline" class="p-4 flex-1 text-[11px] font-bold uppercase transition-all">Baseline</button>
                <button onclick="tab('treatment')" id="b-treatment" class="p-4 flex-1 text-[11px] font-bold uppercase transition-all">Treatment</button>
                <button onclick="tab('maintenance')" id="b-maintenance" class="p-4 flex-1 text-[11px] font-bold uppercase transition-all">Maint</button>
            </div>
        </div>

        <div id="m-list" class="p-4 space-y-3 pb-24 max-w-md mx-auto"></div>

        <div class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center p-3 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-50">
            <button onclick="tab('trials')" id="b-trials" class="flex flex-col items-center w-1/4">
                <span class="text-xl">üìä</span>
                <span class="text-[8px] font-black uppercase mt-1">Trial Sheet</span>
            </button>
            <button onclick="tab('mastered')" id="b-mastered" class="flex flex-col items-center w-1/4">
                <span class="text-xl">üèÜ</span>
                <span class="text-[8px] font-black uppercase mt-1">Mastered</span>
            </button>
            <button onclick="tab('ta_history')" id="b-ta_history" class="flex flex-col items-center w-1/4">
                <span class="text-xl">üìù</span>
                <span class="text-[8px] font-black uppercase mt-1">TA Logs</span>
            </button>
            <button onclick="tab('recall')" id="b-recall" class="flex flex-col items-center w-1/4">
                <span class="text-xl">üìã</span>
                <span class="text-[8px] font-black uppercase mt-1">Recall Log</span>
            </button>
        </div>
    </div>

    <div id="cyc" class="hide fixed inset-0 bg-white z-[220] p-4 text-center flex flex-col overflow-y-auto">
        <div class="flex justify-between items-center pt-8 mb-4">
            <div class="flex flex-col items-start">
                <div id="mode-badge" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[8px] font-black uppercase mb-1 tracking-tighter"></div>
                <div class="text-blue-500 font-black text-[10px] uppercase">Trial: <span id="c-f-name"></span></div>
            </div>
            <div class="flex gap-2">
                <button onclick="openUndoMenu()" class="bg-gray-800 text-white px-4 py-2 rounded-full font-black text-[10px] uppercase shadow-md">Undo ‚Ü∂</button>
                <button onclick="show('skip-modal')" class="bg-red-600 text-white px-4 py-2 rounded-full font-black text-[10px] uppercase italic shadow-md">Skip ‚è≠</button>
            </div>
        </div>
        
        <div id="sbt-timer-container" class="hide mb-4 bg-gray-50 py-3 rounded-2xl border border-gray-100 shadow-inner">
            <div class="text-[8px] font-black text-gray-400 uppercase tracking-widest mb-1">Trial Duration</div>
            <span id="sbt-timer" class="text-4xl font-black font-mono text-indigo-600">00:00</span>
        </div>

        <div class="bg-white p-6 rounded-[35px] border-4 border-blue-500 mb-6 flex items-center justify-center min-h-[120px] shadow-xl">
            <h2 id="c-task" class="text-2xl font-black uppercase text-gray-800 leading-tight"></h2>
        </div>
        
        <div id="std-btns" class="hide grid grid-cols-2 gap-3 flex-1 pb-6">
            <button onclick="clickRec('IND')" class="prompt-btn bg-green-600 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg">Independent</button>
            <button onclick="clickRec('POS')" class="prompt-btn bg-yellow-500 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg">Positional</button>
            <button onclick="clickRec('GES')" class="prompt-btn bg-teal-500 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg">Gestural</button>
            <button onclick="clickRec('VB')" class="prompt-btn bg-blue-500 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg">Verbal</button>
            <button onclick="clickRec('PP')" class="prompt-btn bg-orange-400 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg">Partial Phys</button>
            <button onclick="clickRec('FP')" class="prompt-btn bg-orange-600 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg">Full Phys</button>
            <button onclick="clickRec('INC')" class="prompt-btn bg-red-600 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg">Incorrect</button>
            <button onclick="clickRec('NR')" class="prompt-btn bg-gray-500 text-white rounded-2xl font-black text-[11px] uppercase shadow-lg">No Response</button>
            <button onclick="clickRec('PB')" class="prompt-btn col-span-2 bg-purple-700 text-white py-4 rounded-2xl font-black text-[12px] uppercase shadow-lg">Problem Behavior</button>
        </div>

        <div id="sbt-btns" class="hide flex-1 flex flex-col pb-6">
            <div class="sbt-grid-container shadow-2xl">
                <div class="grid-header">Response (SR)</div>
                <div class="grid-header italic text-indigo-600">Engaged</div>

                <div onclick="clickRec('FCR')" class="grid-cell">FCR</div>
                <div onclick="clickRec('FCR+ENG')" class="grid-cell cell-eng">ENG</div>

                <div onclick="clickRec('TR')" class="grid-cell">TR</div>
                <div onclick="clickRec('TR+ENG')" class="grid-cell cell-eng">ENG</div>

                <div onclick="clickRec('CAB-1')" class="grid-cell">CAB-1</div>
                <div onclick="clickRec('CAB-1+ENG')" class="grid-cell cell-eng">ENG</div>

                <div onclick="clickRec('CAB-2')" class="grid-cell">CAB-2</div>
                <div onclick="clickRec('CAB-2+ENG')" class="grid-cell cell-eng">ENG</div>

                <div onclick="clickRec('CAB-3')" class="grid-cell">CAB-3+</div>
                <div onclick="clickRec('CAB-3+ENG')" class="grid-cell cell-eng">ENG</div>

                <div onclick="clickRec('R1')" class="grid-cell text-red-600 border-t border-black">R1 (DANGER)</div>
                <div onclick="clickRec('R2')" class="grid-cell text-orange-500 border-t border-black">R2 (NON-D)</div>
            </div>
            <button onclick="clickRec('EO/NO-RESPONSE')" class="w-full py-4 border-2 border-dashed border-gray-400 text-gray-500 font-black text-[10px] rounded-2xl uppercase tracking-widest">EO / NO RESPONSE</button>
        </div>

        <button onclick="pauseCycle()" class="text-gray-400 font-bold uppercase text-[10px] mb-8 underline tracking-widest">Pause Trial & Return</button>
    </div>

    <div id="undo-modal" class="hide fixed inset-0 bg-black/90 z-[350] flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-[40px] p-8 flex flex-col max-h-[75vh] shadow-2xl">
            <h3 class="text-center font-black uppercase text-[10px] mb-4 text-gray-400">Undo History</h3>
            <div id="undo-list" class="space-y-3 overflow-y-auto mb-6 pr-1"></div>
            <button onclick="hide('undo-modal')" class="bg-gray-100 text-gray-500 py-4 rounded-2xl font-black uppercase text-[10px]">Close</button>
        </div>
    </div>

    <div id="skip-modal" class="hide fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-[40px] p-8 space-y-3 shadow-2xl text-center">
            <h3 class="font-black uppercase text-[10px] mb-4 text-gray-400">Reason for Skip</h3>
            <button onclick="finishSkip('REFUSAL')" class="w-full bg-red-500 text-white py-4 rounded-2xl font-black uppercase text-[10px] shadow-lg">Refusal</button>
            <button onclick="finishSkip('MATERIALS')" class="w-full bg-gray-800 text-white py-4 rounded-2xl font-black uppercase text-[10px] shadow-lg">Materials</button>
            <button onclick="finishSkip('ENVIRONMENT')" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] shadow-lg">Environment</button>
            <button onclick="hide('skip-modal')" class="w-full text-gray-400 py-4 font-bold uppercase text-[10px]">Cancel</button>
        </div>
    </div>

    <div id="s-prof" class="fixed inset-0 bg-indigo-950 z-[100] p-8 flex flex-col items-center hide">
        <div class="mb-12 mt-12 text-center">
            <h1 class="text-white font-black text-4xl uppercase italic tracking-tighter">Tracker Pro</h1>
            <div class="text-indigo-400 text-[10px] font-black uppercase tracking-widest">Clinical Data Module</div>
        </div>
        <div id="p-list" class="w-full max-w-xs space-y-3 mb-8"></div>
        <div class="w-full max-w-xs bg-white/10 p-5 rounded-[35px] backdrop-blur-lg">
            <input id="p-in" type="text" placeholder="STUDENT NAME..." class="w-full p-4 rounded-2xl mb-4 uppercase font-black outline-none border-none shadow-inner text-center text-sm">
            <button onclick="addP()" class="w-full bg-green-500 text-white font-black py-4 rounded-2xl shadow-xl uppercase text-xs tracking-widest">+ Create Profile</button>
        </div>
    </div>

    <div id="s-loc" class="fixed inset-0 bg-gray-100 z-[90] hide p-6 flex flex-col items-center overflow-y-auto">
        <h1 class="font-black text-3xl mb-10 mt-12 uppercase text-indigo-950 italic underline decoration-indigo-500">Folders</h1>
        <div id="l-list" class="grid grid-cols-2 gap-4 w-full max-w-md mb-8"></div>
        <div class="w-full max-w-md bg-white p-8 rounded-[40px] shadow-xl border border-gray-200">
            <input id="l-in" type="text" placeholder="FOLDER NAME..." class="w-full p-4 rounded-2xl mb-4 uppercase font-black outline-none border-2 border-gray-100 focus:border-indigo-500 transition-all text-sm">
            <button onclick="addL()" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase text-[11px] tracking-widest">+ Add New Folder</button>
        </div>
    </div>

    <script>
        // --- FULL STATE LOGIC (NO SHORTCUTS) ---
        let u, l, f, activeC, sbtInterval, sbtSeconds = 0;
        
        function getDB() {
            let key = "d_" + u + "_" + l;
            let raw = localStorage.getItem(key);
            if (!raw) return [];
            return JSON.parse(raw);
        }

        function saveDB(d) {
            let key = "d_" + u + "_" + l;
            localStorage.setItem(key, JSON.stringify(d));
        }

        function show(id) { document.getElementById(id).classList.remove('hide'); }
        function hide(id) { document.getElementById(id).classList.add('hide'); }

        // --- CORE INITIALIZATION ---
        function init() {
            u = localStorage.getItem('u');
            l = localStorage.getItem('l');
            f = localStorage.getItem('f') || 'baseline';
            
            if (u && l) {
                restore();
            } else if (u) {
                renderL();
            } else {
                renderP();
            }
        }

        function restore() {
            hide('s-loc');
            hide('s-prof');
            show('app');
            document.getElementById('u-lab').innerText = u + " | " + l;
            checkResume();
            refresh();
        }

        // --- NAVIGATION ---
        function tab(x) {
            f = x;
            localStorage.setItem('f', x);
            stopTimer();
            hide('cyc');
            show('app');
            checkResume();
            refresh();
        }

        // --- REFRESH LIST (FULL LOGIC) ---
        function refresh() {
            const list = document.getElementById('m-list');
            list.innerHTML = '';
            
            // Highlight Buttons
            document.getElementById('b-baseline').classList.remove('act-t');
            document.getElementById('b-treatment').classList.remove('act-t');
            document.getElementById('b-maintenance').classList.remove('act-t');
            
            let currentTab = document.getElementById('b-' + f);
            if (currentTab) currentTab.classList.add('act-t');
            
            let d = getDB();

            if (f === 'baseline' || f === 'treatment' || f === 'maintenance') {
                let tasks = d.filter(t => t.f === f && !t.res);
                
                // Add Folder Controls
                list.innerHTML = `
                    <div class="flex gap-3 mb-6">
                        <button onclick="startRandomCycle()" class="flex-1 bg-black text-white py-5 rounded-3xl font-black uppercase text-[10px] shadow-lg">Random Cycle</button>
                        <button onclick="startStraightCycle()" class="flex-1 bg-indigo-600 text-white py-5 rounded-3xl font-black uppercase text-[10px] shadow-lg">Straight Cycle</button>
                    </div>
                    <div class="bg-white p-6 rounded-[35px] shadow-md border border-gray-100 mb-6">
                        <input id="t-in" type="text" placeholder="NAME TASK..." class="w-full p-4 border-2 border-gray-50 rounded-2xl mb-4 uppercase font-black outline-none text-sm focus:border-blue-400">
                        <button onclick="addT()" class="w-full bg-blue-600 text-white py-4 rounded-2xl text-[10px] font-black uppercase">+ Add to ${f}</button>
                    </div>`;

                tasks.forEach(t => {
                    list.innerHTML += `
                        <div class="bg-white p-5 rounded-[32px] border border-gray-100 flex justify-between items-center mb-3 shadow-sm">
                            <div onclick="runById(${t.id})" class="flex-1 font-black uppercase text-sm cursor-pointer py-2">${t.text}</div>
                            <div class="flex gap-3">
                                <button onclick="mov(${t.id})" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-[8px] font-black uppercase italic">Move</button>
                                <button onclick="delT(${t.id})" class="text-red-200 hover:text-red-500 font-bold px-3">‚úï</button>
                            </div>
                        </div>`;
                });
            } else {
                // Log Views
                let headerText = f.replace('_', ' ').toUpperCase();
                list.innerHTML = `<h2 class="text-2xl font-black uppercase mb-6 italic underline decoration-indigo-500">${headerText}</h2>`;
                
                let logData = d.filter(t => t.f === f || (f === 'recall' && t.res)).reverse();
                logData.forEach(t => {
                    list.innerHTML += `
                        <div class="bg-white p-5 rounded-3xl border border-gray-50 mb-3 font-black uppercase text-[10px] flex justify-between items-center shadow-sm">
                            <div class="flex flex-col">
                                <span class="text-gray-900">${t.text}</span>
                                <span class="text-[7px] text-gray-400 mt-1">${t.loc} | ${t.date || '---'}</span>
                            </div>
                            <span class="text-indigo-600 font-black bg-indigo-50 px-3 py-1 rounded-full">${t.res || 'Mastered'}</span>
                        </div>`;
                });
            }
        }

        // --- DATA COLLECTION RUNNER ---
        function runById(id) {
            let d = getDB(); 
            let t = d.find(x => x.id == id); 
            if (!t) return;
            
            activeC = t;
            show('cyc'); 
            hide('app');
            
            document.getElementById('c-task').innerText = t.text;
            document.getElementById('c-f-name').innerText = f.toUpperCase();
            
            // STRICT FOLDER CHECK FOR GRID (NON-SIMPLIFIED)
            let folderName = String(l).toUpperCase().trim();
            if (folderName === "SBT") {
                show('sbt-btns');
                hide('std-btns');
                startTimer();
                document.getElementById('mode-badge').innerText = "SBT GRID MODE";
                document.getElementById('mode-badge').className = "bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[8px] font-black uppercase mb-1 tracking-tighter";
            } else {
                show('std-btns');
                hide('sbt-btns');
                stopTimer();
                document.getElementById('mode-badge').innerText = "DTT PROMPT MODE";
                document.getElementById('mode-badge').className = "bg-blue-100 text-blue-700 px-2 py-1 rounded text-[8px] font-black uppercase mb-1 tracking-tighter";
            }
        }

        function clickRec(v) {
            let d = getDB();
            let finalValue = v;
            
            if (String(l).toUpperCase().trim() === "SBT") {
                let currentTimerValue = document.getElementById('sbt-timer').innerText;
                finalValue = v + " (" + currentTimerValue + ")";
                // Reset timer for next chain/trial
                startTimer();
            }
            
            d.push({
                id: Date.now(),
                text: activeC.text,
                res: finalValue,
                f: 'recall',
                loc: l,
                origin: f,
                date: new Date().toLocaleDateString()
            });
            
            saveDB(d);
            
            if (String(l).toUpperCase().trim() !== "SBT") {
                advance();
            }
        }

        function advance() {
            let queueKey = "queue_" + u + "_" + l + "_" + f;
            let queue = JSON.parse(localStorage.getItem(queueKey) || '[]');
            queue.shift();
            localStorage.setItem(queueKey, JSON.stringify(queue));
            
            if (queue.length > 0) {
                runById(queue[0]); 
            } else {
                pauseCycle();
            }
        }

        // --- TIMER LOGIC ---
        function startTimer() {
            clearInterval(sbtInterval);
            sbtSeconds = 0;
            show('sbt-timer-container');
            document.getElementById('sbt-timer').innerText = "00:00";
            
            sbtInterval = setInterval(function() {
                sbtSeconds++;
                let mins = Math.floor(sbtSeconds / 60).toString().padStart(2, '0');
                let secs = (sbtSeconds % 60).toString().padStart(2, '0');
                document.getElementById('sbt-timer').innerText = mins + ":" + secs;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(sbtInterval);
            hide('sbt-timer-container');
        }

        // --- CYCLE ENGINE ---
        function startRandomCycle() {
            let tasks = getDB().filter(t => t.f === f && !t.res);
            if (tasks.length === 0) return;
            
            let ids = tasks.map(t => t.id);
            for (let i = ids.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [ids[i], ids[j]] = [ids[j], ids[i]];
            }
            
            let queueKey = "queue_" + u + "_" + l + "_" + f;
            localStorage.setItem(queueKey, JSON.stringify(ids));
            runById(ids[0]);
        }

        function startStraightCycle() {
            let tasks = getDB().filter(t => t.f === f && !t.res);
            if (tasks.length === 0) return;
            
            let ids = tasks.map(t => t.id);
            let queueKey = "queue_" + u + "_" + l + "_" + f;
            localStorage.setItem(queueKey, JSON.stringify(ids));
            runById(ids[0]);
        }

        // --- MODAL UTILITIES ---
        function openUndoMenu() {
            let history = getDB().filter(x => x.res).slice(-8).reverse();
            const list = document.getElementById('undo-list');
            list.innerHTML = '';
            
            history.forEach(item => {
                list.innerHTML += `
                    <button onclick="confirmUndo(${item.id})" class="w-full bg-gray-50 p-4 rounded-2xl border flex flex-col items-start shadow-sm active:bg-red-50 transition-colors">
                        <span class="font-black uppercase text-[10px] text-gray-800">${item.text}</span>
                        <span class="text-indigo-600 font-black text-[9px] mt-1 uppercase italic">${item.res}</span>
                    </button>`;
            });
            show('undo-modal');
        }

        function confirmUndo(id) {
            let d = getDB();
            let filtered = d.filter(x => x.id !== id);
            saveDB(filtered);
            hide('undo-modal');
            refresh();
        }

        function finishSkip(reason) {
            let d = getDB();
            d.push({
                id: Date.now(),
                text: activeC.text,
                res: 'SKIP: ' + reason,
                f: 'recall',
                loc: l,
                origin: f,
                date: new Date().toLocaleDateString()
            });
            saveDB(d);
            hide('skip-modal');
            advance();
        }

        // --- SETUP LOGIC (FULL) ---
        function addP() {
            let v = document.getElementById('p-in').value.trim().toUpperCase();
            if (!v) return;
            let p = JSON.parse(localStorage.getItem('profiles') || '[]');
            p.push(v);
            localStorage.setItem('profiles', JSON.stringify(p));
            document.getElementById('p-in').value = '';
            renderP();
        }

        function renderP() {
            hide('s-loc'); hide('app'); show('s-prof');
            let p = JSON.parse(localStorage.getItem('profiles') || '[]');
            const list = document.getElementById('p-list');
            list.innerHTML = '';
            p.forEach(x => {
                list.innerHTML += `<button onclick="selP('${x}')" class="w-full bg-white/20 text-white p-6 rounded-3xl font-black shadow-lg uppercase text-left border border-white/10 active:bg-white/40 transition-all">${x}</button>`;
            });
        }

        function selP(x) { 
            u = x; 
            localStorage.setItem('u', x); 
            renderL(); 
        }

        function addL() {
            let v = document.getElementById('l-in').value.trim().toUpperCase();
            if (!v) return;
            let locs = JSON.parse(localStorage.getItem('locations') || '["SBT", "DTT"]');
            if (!locs.includes(v)) locs.push(v);
            localStorage.setItem('locations', JSON.stringify(locs));
            document.getElementById('l-in').value = '';
            renderL();
        }

        function renderL() {
            hide('s-prof'); hide('app'); show('s-loc');
            let locs = JSON.parse(localStorage.getItem('locations') || '["SBT", "DTT"]');
            const list = document.getElementById('l-list');
            list.innerHTML = '';
            locs.forEach(x => {
                list.innerHTML += `
                    <div class="relative h-24">
                        <button onclick="selL('${x}')" class="w-full h-full bg-white p-4 rounded-3xl shadow-md border-2 border-transparent active:border-indigo-400 font-black uppercase text-indigo-950 transition-all text-xs">${x}</button>
                    </div>`;
            });
        }

        function selL(x) { 
            l = x; 
            localStorage.setItem('l', x); 
            restore(); 
        }

        function addT() { 
            let v = document.getElementById('t-in').value.trim().toUpperCase(); 
            if (!v) return; 
            let d = getDB(); 
            d.push({ id: Date.now(), text: v, f: f }); 
            saveDB(d); 
            document.getElementById('t-in').value = ''; 
            refresh(); 
        }

        function delT(id) { 
            if(confirm('Permanently delete this task?')) { 
                let d = getDB();
                saveDB(d.filter(t => t.id != id)); 
                refresh(); 
            } 
        }

        function mov(id) { 
            let d = getDB(); 
            d.forEach(t => { 
                if (t.id == id) { 
                    if (t.f === 'baseline') t.f = 'treatment';
                    else if (t.f === 'treatment') t.f = 'maintenance';
                    else if (t.f === 'maintenance') t.f = 'mastered';
                    else t.f = 'baseline';
                } 
            }); 
            saveDB(d); 
            refresh(); 
        }

        function checkResume() { 
            let queueKey = "queue_" + u + "_" + l + "_" + f;
            let q = JSON.parse(localStorage.getItem(queueKey) || '[]'); 
            if (q.length > 0) runById(q[0]); 
        }

        function pauseCycle() { 
            stopTimer(); 
            hide('cyc'); 
            show('app'); 
            refresh(); 
        }

        function exitN() { 
            localStorage.removeItem('u'); 
            location.reload(); 
        }

        function exitL() { 
            localStorage.removeItem('l'); 
            location.reload(); 
        }

        init();
    </script>
</body>
</html>
