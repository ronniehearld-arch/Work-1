<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-900">

    <div class="bg-white border-b flex justify-around sticky top-0 z-50 shadow-sm">
        <button onclick="changeFol('treatment')" id="t-treatment" class="p-4 text-[10px] font-black border-b-4 border-blue-600 text-blue-600">TREATMENT</button>
        <button onclick="changeFol('maintenance')" id="t-maintenance" class="p-4 text-[10px] font-black border-b-4 border-transparent text-gray-400">MAINTENANCE</button>
        <button onclick="changeFol('recall')" id="t-recall" class="p-4 text-[10px] font-black border-b-4 border-transparent text-gray-400">RECALL</button>
    </div>

    <div class="p-4 max-w-md mx-auto">
        <div class="flex justify-between items-center mb-4">
            <h1 id="headerTitle" class="font-black text-xl uppercase tracking-tighter text-blue-800">TREATMENT</h1>
            <div class="flex items-center gap-2">
                <span id="cycleCount" class="hidden text-[10px] font-bold text-blue-500"></span>
                <button onclick="toggleCycle()" id="cycleBtn" class="bg-yellow-400 text-blue-900 px-3 py-1 rounded-lg font-bold text-xs shadow">CYCLE MODE</button>
            </div>
        </div>

        <div id="inputSection" class="flex gap-2 mb-6">
            <input id="newInput" type="text" placeholder="Type task here..." class="flex-1 p-4 rounded-2xl border-2 border-gray-200 outline-none shadow-inner bg-white">
            <button onclick="handleAddTask()" class="bg-blue-600 text-white px-8 rounded-2xl font-bold text-2xl shadow-lg active:bg-blue-800">+</button>
        </div>

        <div id="mainList" class="space-y-3"></div>

        <div id="cycleScreen" class="hidden text-center py-4">
            <div class="bg-white p-12 rounded-[40px] shadow-2xl border-4 border-blue-500 mb-8">
                <h2 id="displayTask" class="text-4xl font-black text-gray-800 break-words leading-tight">...</h2>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="record('No')" class="bg-red-500 text-white py-6 rounded-3xl font-black text-xl shadow-lg">✕ NO</button>
                <button onclick="record('Yes')" class="bg-green-500 text-white py-6 rounded-3xl font-black text-xl shadow-lg">✓ YES</button>
            </div>
            <div class="flex flex-col gap-2 items-center">
                <button onclick="resetFolderCycle()" class="text-blue-500 text-[10px] font-bold uppercase tracking-widest">Restart this Folder</button>
                <button onclick="toggleCycle()" class="text-gray-400 font-bold underline p-2">Exit Cycle Mode</button>
            </div>
        </div>
    </div>

    <script>
        // Expanded state to track everything for the "Refresh Fix"
        var state = {
            tasks: [],
            activeFol: 'treatment',
            isCyc: false,
            positions: {
                treatment: 0,
                maintenance: 0,
                recall: 0
            }
        };

        // Saves everything to the browser memory
        function save() {
            localStorage.setItem('task_session_v4', JSON.stringify(state));
        }

        // Loads everything back exactly as it was
        function load() {
            var data = localStorage.getItem('task_session_v4');
            if (data) {
                var loadedState = JSON.parse(data);
                // Merge loaded data into our state
                state = loadedState;
                
                // Ensure positions exists for older saves
                if (!state.positions) {
                    state.positions = { treatment: 0, maintenance: 0, recall: 0 };
                }
                refresh();
            }
        }

        function handleAddTask() {
            var el = document.getElementById('newInput');
            if (!el.value.trim()) return;
            state.tasks.push({ id: Date.now(), txt: el.value, fol: state.activeFol, res: '' });
            el.value = '';
            save();
            refresh();
        }

        function changeFol(f) {
            state.activeFol = f;
            state.isCyc = false;
            save();
            refresh();
        }

        function toggleCycle() {
            var filt = state.tasks.filter(t => t.fol === state.activeFol);
            if (filt.length === 0) return alert("Folder is empty!");
            state.isCyc = !state.isCyc;
            save();
            refresh();
        }

        function resetFolderCycle() {
            state.positions[state.activeFol] = 0;
            save();
            refresh();
        }

        function record(val) {
            var filt = state.tasks.filter(t => t.fol === state.activeFol);
            var cur = filt[state.positions[state.activeFol]];
            
            // Add to Recall
            state.tasks.push({ id: Date.now() + 1, txt: cur.txt, fol: 'recall', res: val });
            
            // Increment position
            state.positions[state.activeFol] = (state.positions[state.activeFol] + 1) % filt.length;
            
            save();
            refresh();
        }

        function move(id, target) {
            state.tasks.forEach(t => { if(t.id === id) t.fol = target; });
            save();
            refresh();
        }

        function remove(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            save();
            refresh();
        }

        function refresh() {
            var L = document.getElementById('mainList');
            var CS = document.getElementById('cycleScreen');
            var IS = document.getElementById('inputSection');
            var HT = document.getElementById('headerTitle');
            var CB = document.getElementById('cycleBtn');
            var CC = document.getElementById('cycleCount');

            HT.innerText = state.activeFol.toUpperCase();
            
            // Update Tab UI
            ['treatment', 'maintenance', 'recall'].forEach(f => {
                var btn = document.getElementById('t-' + f);
                btn.className = "p-4 text-[10px] font-black border-b-4 " + (state.activeFol === f ? "border-blue-600 text-blue-600" : "border-transparent text-gray-400");
            });

            var filtC = state.tasks.filter(t => t.fol === state.activeFol);
            var currentPos = state.positions[state.activeFol];

            if (state.isCyc && filtC.length > 0) {
                // UI for Cycle Mode
                L.style.display = 'none'; IS.style.display = 'none'; CS.style.display = 'block'; CB.style.display = 'none';
                
                if (currentPos >= filtC.length) {
                    state.positions[state.activeFol] = 0;
                    currentPos = 0;
                }

                document.getElementById('displayTask').innerText = filtC[currentPos].txt;
                CC.style.display = 'block';
                CC.innerText = (currentPos + 1) + " / " + filtC.length;
            } else {
                // UI for List Mode
                state.isCyc = false;
                L.style.display = 'block'; CS.style.display = 'none'; CC.style.display = 'none';
                CB.style.display = (state.activeFol === 'recall' && filtC.length === 0 ? 'none' : 'block');
                IS.style.display = (state.activeFol === 'recall' ? 'none' : 'flex');
                
                L.innerHTML = '';
                if (filtC.length === 0) L.innerHTML = '<div class="py-20 text-center text-gray-300 font-black uppercase text-xs">Folder Empty</div>';

                filtC.forEach(t => {
                    var card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center";
                    var btns = '';
                    if (state.activeFol === 'treatment') btns = `<button onclick="move(${t.id},'maintenance')" class="bg-blue-100 text-blue-700 px-3 py-2 rounded-xl text-[10px] font-black">TO MAINT.</button>`;
                    else if (state.activeFol === 'maintenance') btns = `<button onclick="move(${t.id},'treatment')" class="bg-gray-100 text-gray-500 px-3 py-2 rounded-xl text-[10px] font-black">BACK</button>`;
                    else if (state.activeFol === 'recall') btns = `<span class="font-black text-xs mr-2 ${t.res === 'Yes' ? 'text-green-500' : 'text-red-500'}">${t.res.toUpperCase()}</span>`;
                    
                    card.innerHTML = `<span class="font-bold text-gray-700">${t.txt}</span><div class="flex items-center gap-2">${btns}<button onclick="remove(${t.id})" class="text-red-300 font-bold px-2 text-lg">✕</button></div>`;
                    L.appendChild(card);
                });
            }
        }

        // Initialize the app by loading the previous session
        load();
    </script>
</body>
</html>
